\load[vlna]
\load[mte]

\fontfam[biblon]
\chyph
\enablemte

\typosize[11/13]
\hyperlinks\Blue\Blue

\fontdef\chapfont{\setfontsize{at19.pt}\bf}
\fontdef\secfont{\setfontsize{at13.pt}\bf}
\fontdef\markfont{\setfontsize{at7pt}\rm}

\newcount\currsection

\raggedbottom
\parindent=15pt

\def\dopsat{{\Red !!! DOPSAT !!! }}

\def\source#1{}

\def\BibleBook#1#2{\def\currchap{#2}%
   \bigskip {\chapfont #1}\par\nobreak\medskip \currsection=0}

\eoldef\verse#1{\verseA#1\end}
\def\verseA #1 #2\end{\def\currversenum{#1}\def\tmpb{#2}%
   \cs{nt:\currchap:#1}\ea\verseB \tmpb\end}
\def\verseB #1\end{\cs{fmt:\currchap:\currversenum}%
   \ea\versemark\currversenum!#1\endverse}
\def\versemark#1:#2!{\ifnum\currsection=#1\relax \else 
   \currsection=#1 \newsection \fi
   \leavevmode\dest[ref:\currchap:#1:#2]\raise5pt\hbox{\unless\ifnum#2=1\markfont #2\fi}}
\def\newsection{\removelastskip\medskip {\secfont\Red \the\currsection}\medskip}
\def\endverse{ }

%% reading fmt file

\newtoks\fmtchap
\def\fmtdef#1{\sdef{fmt:\the\fmtchap:#1}}

\input fmt-BKR

%% reading notes file

\newtoks\CommentedBook
\newcount\notenum
\def\Note #1 #2 #3\par{\incr\notenum 
   \edef\tmp{\the\CommentedBook:#1}%
   \unless\ifcsname nt:\tmp\endcsname \sdef{nt:\tmp}{}\fi
   \ea \addtonote\ea{\the\notenum}% 
   \sdef{nttext:\the\notenum}{#3}%
   \firstntw #2 ...\end
   \sdef{ntw:\the\notenum\ea}\ea{\tmp}%
   \sdef{ntww:\the\notenum}{#2}%
}
\def\addtonote #1{\ea \addto\csname nt:\tmp\endcsname{\processnote{#1}}}
\def\processnote#1{\edef\tmp{\cs{ntw:#1}}%
   \ifx\tmp\empty \def\tmp{\usenote{}{#1}}\ea\addto\ea\tmp\ea{\tmpb}\let\tmpb=\tmp
   \else \ea\processnoteA\ea{\tmp}{#1}\fi
}
\def\processnoteA#1#2{\replstring\tmpb{#1}{\usenote{#1}{#2}}}
\def\usenote#1#2{{\Magenta\bf#1}\fnote{\normalpar\_xlink{ref}{\currchap:\currversenum}{\Blue}{\currversenum} 
   \space {\refw\cs{ntww:#2}}\unskip\space \scantextokens\ea\ea\ea{\csname nttext:#2\endcsname}%
   \unskip\strut\par \aftergroup\endfootnote}}
\def\refw{\Magenta\bf}
\def\_printfnotemark{}
\def\normalpar{\leftskip=0pt \rightskip=0pt \parfillskip=0pt plus1fil\relax}
\def\endfootnote{\let\_strut=\relax}
\def\firstntw #1 ...#2\end{\def\tmp{#1}}

\def\v/#1/{#1}

\input notes-Da

%% reading generated file

\catcode`<=13
\def<#1>{{\Blue#1}}

%\loggingall
\catcode`#=13 \let#=\verse \input CzeBKR-Da


\bye
